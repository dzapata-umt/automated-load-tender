name: Processing Load Tendering

on:
  workflow_dispatch:
    inputs:
      pickupNumber:
        required: true
      totalRate:
        required: true
      runId:
        required: false

jobs:
  cypress:
    environment: 'PROD'
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install
        run: npm ci

      - name: Run Cypress
        env:
          SHIPPER_REFERENCE: ${{github.event.inputs.pickupNumber}}
          TOTAL_RATE: ${{ github.event.inputs.totalRate }}
          ACCOUNT_ID: ${{secrets.DITAT_ACCOUNT}}
          USERNAME: ${{secrets.USERNAME}}
          PASSWORD: ${{secrets.PASSWORD}}
          RUN_ID: ${{ github.event.inputs.runId }}
        run: |
          npx cypress run

      - name: Updaload Results
        if: always()
        uses: actions/upload-artifact@v4
        with: 
          name: cypress-results-${{ github.event.inputs.runId }}
          path: results.json
    
      - name: Callback n8n with results
        if: always()
        env:
          CALLBACK_URL: ${{ secrets.N8N_CALLBACK_URL }}
          CALLBACK_TOKEN: ${{ secrets.N8N_CALLBACK_TOKEN }}
          SHIPPER_REFERENCE: ${{ github.event.inputs.pickupNumber }}
          TOTAL_RATE: ${{ github.event.inputs.totalRate }}
          RUN_ID: ${{ github.event.inputs.runId }}
          JOB_STATUS: ${{ job.status }}
        run: |
          RESULTS=$(cat results.json | jq -c .)
          curl -sS -X POST "$CALLBACK_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $CALLBACK_TOKEN" \
            -d "{
              \"runId\": \"$RUN_ID\",
              \"status\": \"$JOB_STATUS\",
              \"pickupNumber\": \"$PICKUP_NUMBER\",
              \"totalRate\": \"$TOTAL_RATE\",
              \"results\": $RESULTS
            }"